<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR File Share</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a28;
    --border: #2a2a40;
    --accent: #7c3aed;
    --accent2: #06d6a0;
    --accent3: #ff6b6b;
    --text: #e8e8f0;
    --muted: #6b6b8a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 20% 20%, rgba(124,58,237,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(6,214,160,0.06) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  header {
    text-align: center;
    margin-bottom: 50px;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-size: 2.8rem;
    font-weight: 800;
    background: linear-gradient(135deg, #7c3aed, #06d6a0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.02em;
    line-height: 1;
  }

  .tagline {
    color: var(--muted);
    font-size: 0.8rem;
    margin-top: 8px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .tabs {
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 32px;
  }

  .tab {
    flex: 1;
    padding: 12px;
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'Syne', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    border-radius: 9px;
    transition: all 0.2s;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .tab.active {
    background: var(--accent);
    color: white;
  }

  .tab:hover:not(.active) {
    background: var(--surface2);
    color: var(--text);
  }

  .panel { display: none; }
  .panel.active { display: block; }

  /* Generator Panel */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 16px;
    padding: 60px 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: var(--surface);
    position: relative;
    overflow: hidden;
  }

  .drop-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(124,58,237,0.05), rgba(6,214,160,0.05));
    opacity: 0;
    transition: opacity 0.3s;
  }

  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--accent);
    transform: translateY(-2px);
  }

  .drop-zone:hover::before, .drop-zone.drag-over::before {
    opacity: 1;
  }

  .drop-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    display: block;
  }

  .drop-title {
    font-family: 'Syne', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text);
  }

  .drop-sub {
    color: var(--muted);
    font-size: 0.78rem;
  }

  #fileInput { display: none; }

  .file-info {
    display: none;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-top: 16px;
    align-items: center;
    gap: 12px;
  }

  .file-info.show { display: flex; }

  .file-icon-big { font-size: 2rem; }

  .file-details { flex: 1; }
  .file-name { font-size: 0.85rem; font-weight: 700; color: var(--text); }
  .file-size { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

  .btn {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    padding: 14px 28px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #9333ea);
    color: white;
    width: 100%;
    margin-top: 20px;
  }

  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(124,58,237,0.4); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    font-size: 0.8rem;
    padding: 10px 20px;
  }

  .btn-secondary:hover { border-color: var(--accent2); color: var(--accent2); }

  .status-msg {
    margin-top: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.8rem;
    display: none;
  }

  .status-msg.show { display: block; }
  .status-msg.info { background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.3); color: #a78bfa; }
  .status-msg.success { background: rgba(6,214,160,0.12); border: 1px solid rgba(6,214,160,0.3); color: var(--accent2); }
  .status-msg.error { background: rgba(255,107,107,0.12); border: 1px solid rgba(255,107,107,0.3); color: var(--accent3); }

  .qr-result {
    display: none;
    margin-top: 32px;
    text-align: center;
    animation: fadeUp 0.4s ease;
  }

  .qr-result.show { display: block; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .qr-label {
    font-family: 'Syne', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
  }

  #qrCanvas {
    border-radius: 16px;
    padding: 20px;
    background: white;
    display: inline-block;
    box-shadow: 0 0 60px rgba(124,58,237,0.25);
  }

  .qr-share-url {
    margin-top: 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    text-align: left;
  }

  .qr-share-url span {
    flex: 1;
    font-size: 0.72rem;
    color: var(--muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Scanner Panel */
  .scanner-wrap {
    position: relative;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    aspect-ratio: 1;
    max-width: 480px;
    margin: 0 auto;
  }

  #videoEl {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .scan-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .scan-frame {
    width: 60%;
    aspect-ratio: 1;
    position: relative;
  }

  .scan-frame::before, .scan-frame::after,
  .scan-corner-tl, .scan-corner-tr, .scan-corner-bl, .scan-corner-br {
    content: '';
    position: absolute;
    width: 24px;
    height: 24px;
    border-color: var(--accent2);
    border-style: solid;
  }

  .scan-corner-tl { top: 0; left: 0; border-width: 3px 0 0 3px; }
  .scan-corner-tr { top: 0; right: 0; border-width: 3px 3px 0 0; }
  .scan-corner-bl { bottom: 0; left: 0; border-width: 0 0 3px 3px; }
  .scan-corner-br { bottom: 0; right: 0; border-width: 0 3px 3px 0; }

  .scan-line {
    position: absolute;
    left: 5%;
    right: 5%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent2), transparent);
    animation: scanMove 2s linear infinite;
  }

  @keyframes scanMove {
    0% { top: 5%; }
    100% { top: 95%; }
  }

  .scanner-idle {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    background: var(--surface);
  }

  .scanner-idle-icon { font-size: 4rem; opacity: 0.4; }
  .scanner-idle-text { color: var(--muted); font-size: 0.82rem; text-align: center; line-height: 1.6; }

  .scan-result-box {
    display: none;
    margin-top: 20px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    animation: fadeUp 0.3s ease;
  }

  .scan-result-box.show { display: block; }

  .scan-result-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--accent2);
    margin-bottom: 12px;
  }

  .scan-url-display {
    background: var(--bg);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.75rem;
    color: var(--muted);
    word-break: break-all;
    margin-bottom: 12px;
  }

  .progress-bar {
    height: 4px;
    background: var(--surface);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 12px;
    display: none;
  }

  .progress-bar.show { display: block; }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
    transition: width 0.3s;
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 24px 0;
    color: var(--muted);
    font-size: 0.75rem;
  }

  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .manual-input-row {
    display: flex;
    gap: 8px;
  }

  .text-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 11px 14px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .text-input:focus { border-color: var(--accent); }
  .text-input::placeholder { color: var(--muted); }

  .note-box {
    margin-top: 24px;
    padding: 14px 18px;
    background: rgba(6,214,160,0.06);
    border: 1px solid rgba(6,214,160,0.2);
    border-radius: 10px;
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.7;
  }

  .note-box strong { color: var(--accent2); }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo">‚¨° QRShare</div>
    <div class="tagline">Upload ¬∑ Generate ¬∑ Scan ¬∑ Download</div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('gen')">‚¨Ü Generate QR</button>
    <button class="tab" onclick="switchTab('scan')">‚¨á Scan QR</button>
  </div>

  <!-- GENERATOR PANEL -->
  <div class="panel active" id="panel-gen">
    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
      <span class="drop-icon">üìÅ</span>
      <div class="drop-title">Drop your file here</div>
      <div class="drop-sub">or click to browse ‚Äî any file type supported</div>
    </div>
    <input type="file" id="fileInput">

    <div class="file-info" id="fileInfo">
      <span class="file-icon-big" id="fileIconBig">üìÑ</span>
      <div class="file-details">
        <div class="file-name" id="fileName">‚Äî</div>
        <div class="file-size" id="fileSize">‚Äî</div>
      </div>
      <button class="btn btn-secondary" onclick="clearFile()">‚úï Remove</button>
    </div>

    <div class="status-msg" id="statusMsg"></div>

    <button class="btn btn-primary" id="generateBtn" onclick="generateQR()" disabled>
      ‚¨° Generate QR Code
    </button>

    <div class="qr-result" id="qrResult">
      <div class="qr-label">Scan to download file</div>
      <div id="qrCanvas"></div>
      <div class="qr-share-url">
        <span id="shareUrlText">‚Äî</span>
        <button class="btn btn-secondary" onclick="copyUrl()" style="white-space:nowrap;padding:8px 14px;font-size:0.72rem;">Copy URL</button>
      </div>
    </div>

    <div class="note-box" style="margin-top:24px;">
      <strong>How it works:</strong> Your file is uploaded to a temporary file host (file.io) and a QR code is generated with the download link. When another device scans the QR code, the file downloads automatically. Files expire after 14 days or first download.
    </div>
  </div>

  <!-- SCANNER PANEL -->
  <div class="panel" id="panel-scan">
    <div class="scanner-wrap">
      <video id="videoEl" playsinline autoplay muted></video>
      <div class="scan-overlay" id="scanOverlay" style="display:none;">
        <div class="scan-frame">
          <div class="scan-corner-tl"></div>
          <div class="scan-corner-tr"></div>
          <div class="scan-corner-bl"></div>
          <div class="scan-corner-br"></div>
          <div class="scan-line"></div>
        </div>
      </div>
      <div class="scanner-idle" id="scannerIdle">
        <div class="scanner-idle-icon">üì∑</div>
        <div class="scanner-idle-text">Camera not active<br>Press Start Scanner below</div>
      </div>
    </div>

    <canvas id="scanCanvas" style="display:none;"></canvas>

    <button class="btn btn-primary" id="startScanBtn" onclick="toggleScanner()">
      ‚ñ∂ Start Scanner
    </button>

    <div class="scan-result-box" id="scanResultBox">
      <div class="scan-result-title">‚úì QR Code Detected</div>
      <div class="scan-url-display" id="scanUrlDisplay">‚Äî</div>
      <button class="btn btn-primary" id="downloadBtn" onclick="triggerDownload()" style="margin-top:0;">
        ‚¨á Download File
      </button>
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill" style="width:100%"></div>
      </div>
    </div>

    <div class="divider">or enter URL manually</div>

    <div class="manual-input-row">
      <input type="text" class="text-input" id="manualUrl" placeholder="Paste file URL or QR content here‚Ä¶">
      <button class="btn btn-secondary" onclick="manualDownload()">‚Üì Go</button>
    </div>

    <div class="note-box">
      <strong>Tip:</strong> Point your camera at a QRShare-generated code. The file will be detected and ready to download instantly. Works with any QR code containing a direct file URL.
    </div>
  </div>
</div>

<script>
// ---- Tab switching ----
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  if (tab === 'gen') {
    document.querySelectorAll('.tab')[0].classList.add('active');
    document.getElementById('panel-gen').classList.add('active');
  } else {
    document.querySelectorAll('.tab')[1].classList.add('active');
    document.getElementById('panel-scan').classList.add('active');
  }
}

// ---- File handling ----
let selectedFile = null;

const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
});

document.getElementById('fileInput').addEventListener('change', e => {
  if (e.target.files[0]) setFile(e.target.files[0]);
});

function setFile(file) {
  selectedFile = file;
  document.getElementById('fileName').textContent = file.name;
  document.getElementById('fileSize').textContent = formatSize(file.size);
  document.getElementById('fileIconBig').textContent = getFileIcon(file.name);
  document.getElementById('fileInfo').classList.add('show');
  document.getElementById('generateBtn').disabled = false;
  document.getElementById('qrResult').classList.remove('show');
  hideStatus();
}

function clearFile() {
  selectedFile = null;
  document.getElementById('fileInput').value = '';
  document.getElementById('fileInfo').classList.remove('show');
  document.getElementById('generateBtn').disabled = true;
  document.getElementById('qrResult').classList.remove('show');
  hideStatus();
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

function getFileIcon(name) {
  const ext = name.split('.').pop().toLowerCase();
  const icons = { pdf:'üìï', doc:'üìò', docx:'üìò', xls:'üìó', xlsx:'üìó', ppt:'üìô', pptx:'üìô',
    jpg:'üñº', jpeg:'üñº', png:'üñº', gif:'üñº', svg:'üé®', mp4:'üé¨', mp3:'üéµ', wav:'üéµ',
    zip:'üì¶', rar:'üì¶', gz:'üì¶', exe:'‚öôÔ∏è', dmg:'üíø', txt:'üìù', csv:'üìä', json:'üîß' };
  return icons[ext] || 'üìÑ';
}

// ---- QR Generation ----
async function generateQR() {
  if (!selectedFile) return;

  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Uploading‚Ä¶';
  showStatus('Uploading file to temporary host‚Ä¶', 'info');

  try {
    const formData = new FormData();
    formData.append('file', selectedFile);

    const resp = await fetch('https://file.io/?expires=14d', {
      method: 'POST',
      body: formData
    });

    if (!resp.ok) throw new Error('Upload failed: ' + resp.statusText);
    const data = await resp.json();

    if (!data.success || !data.link) throw new Error(data.message || 'Upload failed');

    const url = data.link;
    showStatus('File uploaded! QR code generated.', 'success');
    renderQR(url);
  } catch (err) {
    // Fallback: if file is small enough, encode as data URL
    if (selectedFile.size < 2000) {
      const reader = new FileReader();
      reader.onload = e => {
        showStatus('Small file encoded directly in QR.', 'success');
        renderQR(e.target.result);
      };
      reader.readAsDataURL(selectedFile);
    } else {
      showStatus('Upload failed: ' + err.message + '. Try a smaller file or check your connection.', 'error');
    }
  }

  btn.disabled = false;
  btn.textContent = '‚¨° Generate QR Code';
}

function renderQR(url) {
  const container = document.getElementById('qrCanvas');
  container.innerHTML = '';
  new QRCode(container, {
    text: url,
    width: 240,
    height: 240,
    colorDark: '#1a1a28',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });
  document.getElementById('shareUrlText').textContent = url;
  document.getElementById('qrResult').classList.add('show');
}

function copyUrl() {
  const url = document.getElementById('shareUrlText').textContent;
  navigator.clipboard.writeText(url).then(() => {
    showStatus('URL copied to clipboard!', 'success');
    setTimeout(hideStatus, 2000);
  });
}

function showStatus(msg, type) {
  const el = document.getElementById('statusMsg');
  el.textContent = msg;
  el.className = 'status-msg show ' + type;
}

function hideStatus() {
  document.getElementById('statusMsg').classList.remove('show');
}

// ---- Scanner ----
let stream = null;
let scanning = false;
let animFrame = null;
let scannedUrl = null;

async function toggleScanner() {
  if (scanning) {
    stopScanner();
  } else {
    startScanner();
  }
}

async function startScanner() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    const video = document.getElementById('videoEl');
    video.srcObject = stream;
    video.play();
    document.getElementById('scannerIdle').style.display = 'none';
    document.getElementById('scanOverlay').style.display = 'flex';
    document.getElementById('startScanBtn').textContent = '‚èπ Stop Scanner';
    scanning = true;
    requestAnimationFrame(scanTick);
  } catch (e) {
    alert('Camera access denied or unavailable: ' + e.message);
  }
}

function stopScanner() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
  scanning = false;
  cancelAnimationFrame(animFrame);
  const video = document.getElementById('videoEl');
  video.srcObject = null;
  document.getElementById('scannerIdle').style.display = 'flex';
  document.getElementById('scanOverlay').style.display = 'none';
  document.getElementById('startScanBtn').textContent = '‚ñ∂ Start Scanner';
}

function scanTick() {
  if (!scanning) return;
  const video = document.getElementById('videoEl');
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    const canvas = document.getElementById('scanCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: 'dontInvert' });
    if (code) {
      handleScannedCode(code.data);
      return;
    }
  }
  animFrame = requestAnimationFrame(scanTick);
}

function handleScannedCode(data) {
  scannedUrl = data;
  stopScanner();
  document.getElementById('scanUrlDisplay').textContent = data;
  document.getElementById('scanResultBox').classList.add('show');
  // Auto-trigger download
  triggerDownload();
}

function triggerDownload() {
  const url = scannedUrl || document.getElementById('scanUrlDisplay').textContent;
  if (!url || url === '‚Äî') return;

  document.getElementById('progressBar').classList.add('show');

  // Attempt download via anchor
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';

  // Extract filename from URL
  try {
    const u = new URL(url);
    const parts = u.pathname.split('/');
    const last = parts[parts.length - 1];
    if (last && last.includes('.')) a.download = decodeURIComponent(last);
  } catch(e) {}

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  setTimeout(() => document.getElementById('progressBar').classList.remove('show'), 2000);
}

function manualDownload() {
  const url = document.getElementById('manualUrl').value.trim();
  if (!url) return;
  scannedUrl = url;
  document.getElementById('scanUrlDisplay').textContent = url;
  document.getElementById('scanResultBox').classList.add('show');
  triggerDownload();
}
</script>
</body>
</html>
